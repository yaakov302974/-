// ==========================================
// הצהרת הון — Google Apps Script
// הדבק קוד זה ב-script.google.com
// ==========================================

const SHEET_NAME = 'הצהרות הון';
const DRIVE_FOLDER_NAME = 'הצהרות הון — מסמכים';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    saveToSheet(data);
    if (data.files) saveFilesToDrive(data);
    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Allow GET for testing
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({ status: 'ok', message: 'Script is live!' }))
    .setMimeType(ContentService.MimeType.JSON);
}

// ==========================================
function saveToSheet(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    // Headers
    const headers = [
      'שנת מס', 'תאריך שליחה', 'שם לקוח', 'ת.ז.', 'בן/בת זוג', 'ת.ז. בן/בת זוג',
      'טלפון', 'דוא"ל', 'ילדים',
      'בנקים (JSON)', 'נדל"ן (JSON)', 'כלי רכב (JSON)',
      'תכולה (JSON)', 'חובות (JSON)', 'אחר (JSON)',
      'הערות', 'קבצים'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#0f3460').setFontColor('#ffffff');
    sheet.setFrozenRows(1);
  }

  const filesSummary = data.filesSummary
    ? Object.entries(data.filesSummary).map(([k,v]) => `${k}: ${v.join(', ')}`).join('\n')
    : '';

  const row = [
    data.taxYear,
    data.submittedAt,
    data.client?.name || '',
    data.client?.id || '',
    data.client?.spouseName || '',
    data.client?.spouseId || '',
    data.client?.phone || '',
    data.client?.email || '',
    data.client?.children || '',
    JSON.stringify(data.banks || []),
    JSON.stringify(data.realEstate || []),
    JSON.stringify(data.vehicles || []),
    JSON.stringify(data.contents || []),
    JSON.stringify(data.debts || []),
    JSON.stringify(data.other || []),
    data.notes || '',
    filesSummary
  ];

  sheet.appendRow(row);

  // Auto-resize columns
  sheet.autoResizeColumns(1, 9);

  // Also write a detailed sheet per client
  writeDetailSheet(data, ss);
}

// ==========================================
function writeDetailSheet(data, ss) {
  const clientName = data.client?.name || 'לקוח';
  const year = data.taxYear || '';
  const sheetTitle = `${clientName} ${year}`.substring(0, 50);

  let detail = ss.getSheetByName(sheetTitle);
  if (detail) ss.deleteSheet(detail); // overwrite if exists
  detail = ss.insertSheet(sheetTitle);

  let r = 1;
  function addHeader(title) {
    detail.getRange(r, 1, 1, 4).merge().setValue(title)
      .setFontWeight('bold').setBackground('#0f3460').setFontColor('#c9a84c').setFontSize(12);
    r++;
  }
  function addRow(label, value) {
    detail.getRange(r, 1).setValue(label).setFontWeight('bold');
    detail.getRange(r, 2, 1, 3).merge().setValue(value || '—');
    r++;
  }
  function blank() { r++; }

  // Client details
  addHeader('פרטי לקוח — הצהרת הון ' + year);
  addRow('שם', data.client?.name);
  addRow('ת.ז.', data.client?.id);
  addRow('בן/בת זוג', data.client?.spouseName);
  addRow('ת.ז. בן/בת זוג', data.client?.spouseId);
  addRow('טלפון', data.client?.phone);
  addRow('דוא"ל', data.client?.email);
  addRow('ילדים', data.client?.children);
  blank();

  // Banks
  addHeader('חשבונות בנק');
  if (data.banks?.length) {
    detail.getRange(r, 1, 1, 4).setValues([['בנק','חשבון','סוג','יתרה']]).setFontWeight('bold').setBackground('#e8d5a3');
    r++;
    data.banks.forEach(b => {
      detail.getRange(r, 1, 1, 4).setValues([[b.bank, b.account, b.type, b.balance]]);
      r++;
    });
  } else { addRow('', 'לא הוזן'); }
  blank();

  // Real Estate
  addHeader('נדל"ן');
  if (data.realEstate?.length) {
    detail.getRange(r, 1, 1, 4).setValues([['כתובת','סוג','שנת רכישה','עלות']]).setFontWeight('bold').setBackground('#e8d5a3');
    r++;
    data.realEstate.forEach(re => {
      detail.getRange(r, 1, 1, 4).setValues([[re.address, re.type, re.year, re.cost]]);
      r++;
    });
  } else { addRow('', 'לא הוזן'); }
  blank();

  // Vehicles
  addHeader('כלי רכב');
  if (data.vehicles?.length) {
    detail.getRange(r, 1, 1, 4).setValues([['דגם','שנה','לוחית','מחיר']]).setFontWeight('bold').setBackground('#e8d5a3');
    r++;
    data.vehicles.forEach(v => {
      detail.getRange(r, 1, 1, 4).setValues([[v.model, v.year, v.plate, v.price]]);
      r++;
    });
  } else { addRow('', 'לא הוזן'); }
  blank();

  // Contents
  addHeader('תכולת הבית');
  if (data.contents?.length) {
    detail.getRange(r, 1, 1, 3).setValues([['תיאור','קטגוריה','שווי']]).setFontWeight('bold').setBackground('#e8d5a3');
    r++;
    data.contents.forEach(c => {
      detail.getRange(r, 1, 1, 3).setValues([[c.desc, c.category, c.value]]);
      r++;
    });
  } else { addRow('', 'לא הוזן'); }
  blank();

  // Debts
  addHeader('התחייבויות');
  if (data.debts?.length) {
    detail.getRange(r, 1, 1, 4).setValues([['מלווה','סוג','יתרת חוב','תאריך פירעון']]).setFontWeight('bold').setBackground('#e8d5a3');
    r++;
    data.debts.forEach(d => {
      detail.getRange(r, 1, 1, 4).setValues([[d.lender, d.type, d.balance, d.endDate]]);
      r++;
    });
  } else { addRow('', 'לא הוזן'); }
  blank();

  // Other
  addHeader('רכוש אחר');
  if (data.other?.length) {
    detail.getRange(r, 1, 1, 3).setValues([['תיאור','סוג','סכום']]).setFontWeight('bold').setBackground('#e8d5a3');
    r++;
    data.other.forEach(o => {
      detail.getRange(r, 1, 1, 3).setValues([[o.desc, o.type, o.value]]);
      r++;
    });
  } else { addRow('', 'לא הוזן'); }
  blank();

  addHeader('הערות');
  addRow('', data.notes);

  detail.autoResizeColumns(1, 4);
}

// ==========================================
function saveFilesToDrive(data) {
  let folder;
  const folders = DriveApp.getFoldersByName(DRIVE_FOLDER_NAME);
  folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(DRIVE_FOLDER_NAME);

  const clientName = data.client?.name || 'לקוח';
  const year = data.taxYear || '';
  const clientFolderName = `${clientName} — ${year}`;

  let clientFolder;
  const cFolders = folder.getFoldersByName(clientFolderName);
  clientFolder = cFolders.hasNext() ? cFolders.next() : folder.createFolder(clientFolderName);

  // Save each file
  Object.entries(data.files || {}).forEach(([category, files]) => {
    if (!files?.length) return;
    let catFolder;
    const catFolders = clientFolder.getFoldersByName(category);
    catFolder = catFolders.hasNext() ? catFolders.next() : clientFolder.createFolder(category);

    files.forEach(file => {
      if (!file?.data) return;
      const decoded = Utilities.base64Decode(file.data);
      const blob = Utilities.newBlob(decoded, file.type, file.name);
      catFolder.createFile(blob);
    });
  });
}
